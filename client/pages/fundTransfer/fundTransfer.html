<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fund Transfer</title>
  <link rel="stylesheet" href="fundTransfer.css">
</head>
<body>
  <div class="container">
    <div class="page-title">
        <h2>üí∞ Fund Transfer</h2>
    </div>

    <!-- Account Card -->
    <div class="account-card" id="accountCard">
        <div class="card-header">
            <span>üí≥ Online Banking</span>
            <span class="account-type" id="accountType">Current</span>
        </div>
        <div class="card-body">
            <p class="account-number" id="accountNumber">Loading...</p>
            <p class="account-holder" id="accountHolder">Mr. Ashok Shekade</p>
            <p class="balance" id="accountBalance">üí∞ Balance: Loading...</p>
        </div>
        <div class="card-footer">
            <small>Customer ID: <span id="customerId">100</span></small>
        </div>
    </div>

    <!-- Transfer Method -->
    <div class="section transfer-method">
      <h3>Choose Transfer Method</h3>
      <div class="methods">
        <div class="method" onclick="selectMethod('self', this)">
          <span class="icon">üí∞</span>
          <span class="text">Self Deposit</span>
          <span class="arrow">‚ûù</span>
        </div>
        <div class="method" onclick="selectMethod('payee', this)">
          <span class="icon">üë•</span>
          <span class="text">Payee Transfer</span>
          <span class="arrow">‚ûù</span>
        </div>
        <div class="method" onclick="selectMethod('manual', this)">
          <span class="icon">üè¶</span>
          <span class="text">Bank Transfer</span>
          <span class="arrow">‚ûù</span>
        </div>
      </div>
    </div>

    <!-- Dynamic Form Container -->
    <div id="dynamicFormContainer"></div>
  </div>

  <script>
    const accountId = 3; // Current user ID (change as needed)
    let defaultFromAccount = '';
    let payeesList = [];

    // Fetch account details from backend
    async function fetchAccountDetails(accountId) {
      try {
        const res = await fetch(`http://localhost:8080/accounts/${accountId}`);
        if (!res.ok) throw new Error('Failed to fetch account');
        return await res.json();
      } catch (err) {
        console.error(err);
        return { accountNumber: '', balance: 0, accountType: 'Current', customerId: accountId };
      }
    }

    async function fetchPayees() {
      try {
        const res = await fetch(`http://localhost:8080/payees/account/${accountId}`);
        if (!res.ok) return [];
        return await res.json();
      } catch {
        return [];
      }
    }

    // Update Account Card UI
    async function updateAccountCard() {
      const data = await fetchAccountDetails(accountId);
      defaultFromAccount = data.accountNumber;
      document.getElementById('accountNumber').textContent = data.accountNumber;
      document.getElementById('accountBalance').textContent = `üí∞ Balance: ‚Çπ${data.balance.toLocaleString()}`;
      document.getElementById('accountType').textContent = data.accountType;
      document.getElementById('customerId').textContent = data.customerId;
    }

    // Transfer Details HTML
    function getTransferDetails(method) {
      if(method === 'self'){
        return `
        <form id="selfTransferForm" class="transfer-details">
          <h3>Self Deposit</h3>
          <div class="input-group">
            <label>From Account</label>
            <input type="text" value="${defaultFromAccount}" readonly>
          </div>
          <div class="input-group">
            <label>To Account</label>
            <input type="text" placeholder="Enter account number">
          </div>
          <div class="input-group">
            <label>Amount (‚Çπ)</label>
            <input type="number" id="amount" placeholder="Enter amount">
          </div>
          <div class="input-group">
            <label>Remarks</label>
            <input type="text" id="remarks" placeholder="Optional remarks">
          </div>
          <div class="input-group">
            <label>Transaction Mode</label>
            <select id="mode">
              <option value="IMPS">IMPS</option>
              <option value="NEFT">NEFT</option>
              <option value="RTGS">RTGS</option>
            </select>
          </div>
          <button type="submit" class="btn submit-btn">Transfer</button>
        </form>`;
      } else if(method === 'payee'){
        return `
        <form id="payeeTransferForm" class="transfer-details">
          <h3>Payee Transfer</h3>
          <div class="input-group">
            <label>From Account</label>
            <input type="text" value="${defaultFromAccount}" readonly>
          </div>
          <div class="input-group">
            <label>Select Payee</label>
            <select id="payeeSelect">
              <option value="">Loading...</option>
            </select>
          </div>
          <div class="input-group">
            <label>Amount (‚Çπ)</label>
            <input type="number" id="payeeAmount" placeholder="Enter amount">
          </div>
          <div class="input-group">
            <label>Transaction Mode</label>
            <select id="payeeMode">
              <option value="IMPS">IMPS</option>
              <option value="NEFT">NEFT</option>
              <option value="RTGS">RTGS</option>
            </select>
          </div>
          <button type="submit" class="btn submit-btn">Transfer</button>
        </form>`;
      } else if(method === 'manual'){
        return `
        <form id="manualTransferForm" class="transfer-details">
          <h3>Bank Transfer</h3>
          <div class="input-group">
            <label>Recipient Account Number</label>
            <input type="text" id="manualAccount" placeholder="Enter account number">
          </div>
          <div class="input-group">
            <label>IFSC Code</label>
            <input type="text" id="manualIFSC" placeholder="Enter IFSC code">
          </div>
          <div class="input-group">
            <label>Amount (‚Çπ)</label>
            <input type="number" id="manualAmount" placeholder="Enter amount">
          </div>
          <div class="input-group">
            <label>Transaction Mode</label>
            <select id="manualMode">
              <option value="IMPS">IMPS</option>
              <option value="NEFT">NEFT</option>
              <option value="RTGS">RTGS</option>
            </select>
          </div>
          <button type="submit" class="btn submit-btn">Transfer</button>
        </form>`;
      }
    }

    // Insert transfer form
    async function selectMethod(method, element) {
      document.querySelectorAll('.method').forEach(m => m.classList.remove('active'));
      document.querySelectorAll('.transfer-details').forEach(d => d.remove());
      element.classList.add('active');

      const html = getTransferDetails(method);
      element.insertAdjacentHTML('afterend', html);

      if(method === 'payee'){
        payeesList = await fetchPayees();
        const select = document.getElementById('payeeSelect');
        select.innerHTML = payeesList.length
          ? payeesList.map(p => `<option value="${p.payeeAccNo}">${p.payeeName}</option>`).join('')
          : '<option value="">No payees</option>';
      }

      setupFormSubmit(method);
    }

    // Form submission
    function setupFormSubmit(method){
      let form;
      if(method === 'self') form = document.getElementById('selfTransferForm');
      else if(method === 'payee') form = document.getElementById('payeeTransferForm');
      else if(method === 'manual') form = document.getElementById('manualTransferForm');

      form.addEventListener('submit', async e => {
        e.preventDefault();
        let payload = {};
        if(method === 'self'){
          const toAcc = form.querySelector('input[placeholder="Enter account number"]').value.trim();
          const amt = form.querySelector('#amount').value.trim();
          const mode = form.querySelector('#mode').value;
          if(!toAcc || !amt) return alert('Enter valid details!');
          payload = { account:{accountNumber: defaultFromAccount}, recvAcc:{accountNumber: toAcc}, amount: Number(amt), transactionMode: mode };
          await sendTransfer(payload, 'self');
        } else if(method === 'payee'){
          const payeeAcc = form.querySelector('#payeeSelect').value;
          const amt = form.querySelector('#payeeAmount').value.trim();
          const mode = form.querySelector('#payeeMode').value;
          if(!payeeAcc || !amt) return alert('Enter valid details!');
          payload = { account:{accountNumber: defaultFromAccount}, recvAcc:{accountNumber: payeeAcc}, amount: Number(amt), transactionMode: mode };
          await sendTransfer(payload, 'payee');
        } else if(method === 'manual'){
          const acc = form.querySelector('#manualAccount').value.trim();
          const amt = form.querySelector('#manualAmount').value.trim();
          const mode = form.querySelector('#manualMode').value;
          if(!acc || !amt) return alert('Enter valid details!');
          payload = { account:{accountNumber: defaultFromAccount}, recvAcc:{accountNumber: acc}, amount: Number(amt), transactionMode: mode };
          await sendTransfer(payload, 'manual');
        }
      });
    }

    async function sendTransfer(payload, type){
      let url = '';
      if(type === 'self' || type === 'manual') url = 'http://localhost:8080/transfers/bank';
      else if(type === 'payee') url = 'http://localhost:8080/transfers/payee';

      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        if(res.ok) alert('‚úÖ Transfer Successful!');
        else alert('‚ùå Transfer Failed');
        document.querySelectorAll('.transfer-details').forEach(d => d.remove());
        document.querySelectorAll('.method').forEach(m => m.classList.remove('active'));
        await updateAccountCard(); // refresh balance
      }catch(err){
        console.error(err);
        alert('Network error!');
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', updateAccountCard);
  </script>
</body>
</html>
